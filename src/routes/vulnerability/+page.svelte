<script lang="ts">
	import { onMount } from 'svelte';
	import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '$lib/components/ui/card';
	import { Button } from '$lib/components/ui/button';
	import { Badge } from '$lib/components/ui/badge';
	import { Progress } from '$lib/components/ui/progress';
	import { ScrollArea } from '$lib/components/ui/scroll-area';
	import { cn } from '$lib/utils';
	import * as api from '$lib/api';
	import { open } from '@tauri-apps/api/shell';
	import { 
		Bug, 
		Search, 
		AlertTriangle,
		CheckCircle,
		ExternalLink,
		RefreshCw,
		Shield,
		Clock
	} from 'lucide-svelte';

	function learnMore(cveId: string | null) {
		if (cveId) {
			open(`https://nvd.nist.gov/vuln/detail/${cveId}`);
		}
	}

	let vulnerabilities: api.Vulnerability[] = [];
	let loading = true;
	let scanning = false;

	onMount(async () => {
		await loadVulnerabilities();
	});

	async function loadVulnerabilities() {
		try {
			loading = true;
			vulnerabilities = await api.getVulnerabilities();
		} catch (error) {
			console.error('Failed to load vulnerabilities:', error);
		} finally {
			loading = false;
		}
	}

	let lastScannedAt: Date | null = null;

	async function startScan() {
		scanning = true;
		try {
			await api.scanVulnerabilities();
			await loadVulnerabilities();
			lastScannedAt = new Date();
		} finally {
			scanning = false;
		}
	}

	function formatLastScanned(): string {
		if (!lastScannedAt) return 'Never';
		const now = new Date();
		const diffMs = now.getTime() - lastScannedAt.getTime();
		if (diffMs < 60000) return 'Just now';
		if (diffMs < 3600000) return `${Math.floor(diffMs / 60000)}m ago`;
		return lastScannedAt.toLocaleTimeString();
	}

	function getSeverityStyles(severity: string): { bg: string; text: string; border: string } {
		switch (severity) {
			case 'critical':
				return { bg: 'bg-neon-red/10', text: 'text-neon-red', border: 'border-neon-red/30' };
			case 'high':
				return { bg: 'bg-cyber-orange/10', text: 'text-cyber-orange', border: 'border-cyber-orange/30' };
			case 'medium':
				return { bg: 'bg-neon-yellow/10', text: 'text-neon-yellow', border: 'border-neon-yellow/30' };
			case 'low':
				return { bg: 'bg-neon-green/10', text: 'text-neon-green', border: 'border-neon-green/30' };
			default:
				return { bg: 'bg-muted', text: 'text-muted-foreground', border: 'border-border' };
		}
	}

	$: criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
	$: highCount = vulnerabilities.filter(v => v.severity === 'high').length;
	$: mediumCount = vulnerabilities.filter(v => v.severity === 'medium').length;
	$: lowCount = vulnerabilities.filter(v => v.severity === 'low').length;
</script>

<svelte:head>
	<title>Vulnerability Scanner - Cyber Security Prime</title>
</svelte:head>

<div class="space-y-6">
	<!-- Header -->
	<div class="flex items-center justify-between">
		<div class="flex items-center gap-3">
			<div class="flex items-center justify-center w-12 h-12 rounded-xl bg-neon-yellow/10">
				<Bug class="w-6 h-6 text-neon-yellow" />
			</div>
			<div>
				<h1 class="text-2xl font-bold tracking-tight text-foreground">
					Vulnerability Scanner
				</h1>
				<p class="text-muted-foreground">
					Identify security vulnerabilities in your system
				</p>
			</div>
		</div>
		<Button 
			variant="cyber" 
			on:click={startScan}
			disabled={scanning}
		>
			{#if scanning}
				<RefreshCw class="w-4 h-4 mr-2 animate-spin" />
				Scanning...
			{:else}
				<Search class="w-4 h-4 mr-2" />
				Scan Now
			{/if}
		</Button>
	</div>

	{#if scanning}
		<Card variant="glass">
			<CardContent class="py-8">
				<div class="flex flex-col items-center space-y-4">
					<div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin" />
					<div class="text-center">
						<p class="font-medium">Scanning for vulnerabilities...</p>
						<p class="text-sm text-muted-foreground mt-1">This may take a few moments</p>
					</div>
					<Progress value={65} variant="neon" class="w-64" />
				</div>
			</CardContent>
		</Card>
	{:else}
		<div class="grid grid-cols-12 gap-6">
			<!-- Stats -->
			<div class="col-span-12">
				<div class="grid grid-cols-5 gap-4">
					<Card variant="glass">
						<CardContent class="pt-6 text-center">
							<p class="text-3xl font-bold">{vulnerabilities.length}</p>
							<p class="text-sm text-muted-foreground mt-1">Total Found</p>
						</CardContent>
					</Card>
					<Card variant="glass" class="border-neon-red/30">
						<CardContent class="pt-6 text-center">
							<p class="text-3xl font-bold text-neon-red">{criticalCount}</p>
							<p class="text-sm text-muted-foreground mt-1">Critical</p>
						</CardContent>
					</Card>
					<Card variant="glass" class="border-cyber-orange/30">
						<CardContent class="pt-6 text-center">
							<p class="text-3xl font-bold text-cyber-orange">{highCount}</p>
							<p class="text-sm text-muted-foreground mt-1">High</p>
						</CardContent>
					</Card>
					<Card variant="glass" class="border-neon-yellow/30">
						<CardContent class="pt-6 text-center">
							<p class="text-3xl font-bold text-neon-yellow">{mediumCount}</p>
							<p class="text-sm text-muted-foreground mt-1">Medium</p>
						</CardContent>
					</Card>
					<Card variant="glass" class="border-neon-green/30">
						<CardContent class="pt-6 text-center">
							<p class="text-3xl font-bold text-neon-green">{lowCount}</p>
							<p class="text-sm text-muted-foreground mt-1">Low</p>
						</CardContent>
					</Card>
				</div>
			</div>

			<!-- Vulnerability List -->
			<div class="col-span-12">
				<Card variant="glass">
					<CardHeader>
						<div class="flex items-center justify-between">
							<div>
								<CardTitle>Detected Vulnerabilities</CardTitle>
								<CardDescription>
									Review and remediate security issues
								</CardDescription>
							</div>
							<div class="flex items-center gap-2 text-sm text-muted-foreground">
								<Clock class="w-4 h-4" />
								Last scanned: {formatLastScanned()}
							</div>
						</div>
					</CardHeader>
					<CardContent>
						{#if loading}
							<div class="flex items-center justify-center h-64">
								<div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin" />
							</div>
						{:else if vulnerabilities.length === 0}
							<div class="flex flex-col items-center justify-center h-64 text-center">
								<div class="w-16 h-16 rounded-full bg-neon-green/10 flex items-center justify-center mb-4">
									<Shield class="w-8 h-8 text-neon-green" />
								</div>
								<p class="text-lg font-medium text-neon-green">All Clear!</p>
								<p class="text-sm text-muted-foreground mt-1">No vulnerabilities detected</p>
							</div>
						{:else}
							<ScrollArea class="max-h-[500px]">
								<div class="space-y-4">
									{#each vulnerabilities as vuln}
										{@const styles = getSeverityStyles(vuln.severity)}
										<div class={cn(
											'p-4 rounded-lg border transition-all hover:shadow-lg',
											styles.bg,
											styles.border
										)}>
											<div class="flex items-start justify-between">
												<div class="flex items-start gap-4">
													<div class={cn(
														'w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0',
														styles.bg
													)}>
														<AlertTriangle class={cn('w-5 h-5', styles.text)} />
													</div>
													<div class="space-y-2">
														<div class="flex items-center gap-2">
															<h3 class="font-medium">{vuln.title}</h3>
															{#if vuln.cve_id}
																<Badge variant="outline" class="font-mono text-xs">
																	{vuln.cve_id}
																</Badge>
															{/if}
														</div>
														<p class="text-sm text-muted-foreground">{vuln.description}</p>
														<div class="flex items-center gap-4 text-sm">
															<span class="text-muted-foreground">
																Affected: <span class="text-foreground">{vuln.affected_software}</span>
															</span>
															<span class="text-muted-foreground">
																Version: <span class="font-mono">{vuln.current_version}</span>
															</span>
															{#if vuln.fixed_version}
																<span class="text-muted-foreground">
																	Fix: <span class="text-neon-green font-mono">{vuln.fixed_version}</span>
																</span>
															{/if}
														</div>
														<div class="pt-2 border-t border-border/50">
															<p class="text-sm text-muted-foreground">
																<span class="font-medium text-foreground">Remediation:</span> {vuln.remediation}
															</p>
														</div>
													</div>
												</div>
												<div class="flex flex-col items-end gap-2">
													<Badge variant={vuln.severity === 'critical' || vuln.severity === 'high' ? 'danger' : vuln.severity === 'medium' ? 'warning' : 'success'} class="uppercase">
														{vuln.severity}
													</Badge>
												<Button variant="ghost" size="sm" on:click={() => learnMore(vuln.cve_id)}>
													<ExternalLink class="w-4 h-4 mr-1" />
													Learn More
												</Button>
												</div>
											</div>
										</div>
									{/each}
								</div>
							</ScrollArea>
						{/if}
					</CardContent>
				</Card>
			</div>
		</div>
	{/if}
</div>

