// Cyber Security Prime - Vulnerability Scanner Module
// Scans for system vulnerabilities and outdated software

use crate::utils::{generate_id, Severity};
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct VulnerabilityScan {
    pub id: String,
    pub status: String,
    pub started_at: DateTime<Utc>,
    pub completed_at: Option<DateTime<Utc>>,
    pub vulnerabilities_found: u32,
    pub items_scanned: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Vulnerability {
    pub id: String,
    pub cve_id: Option<String>,
    pub title: String,
    pub description: String,
    pub severity: Severity,
    pub affected_software: String,
    pub current_version: String,
    pub fixed_version: Option<String>,
    pub detected_at: DateTime<Utc>,
    pub status: String,
    pub remediation: String,
}

/// Start a vulnerability scan
pub fn start_scan() -> Result<VulnerabilityScan, String> {
    Ok(VulnerabilityScan {
        id: generate_id(),
        status: "running".to_string(),
        started_at: chrono::Utc::now(),
        completed_at: None,
        vulnerabilities_found: 0,
        items_scanned: 0,
    })
}

/// Get all detected vulnerabilities
pub fn get_vulnerabilities() -> Result<Vec<Vulnerability>, String> {
    Ok(vec![
        Vulnerability {
            id: generate_id(),
            cve_id: Some("CVE-2024-21351".to_string()),
            title: "Windows SmartScreen Security Feature Bypass".to_string(),
            description: "A security feature bypass vulnerability exists in Windows SmartScreen that could allow an attacker to bypass security warnings.".to_string(),
            severity: Severity::High,
            affected_software: "Windows 10/11".to_string(),
            current_version: "10.0.19045".to_string(),
            fixed_version: Some("KB5034441".to_string()),
            detected_at: chrono::Utc::now(),
            status: "open".to_string(),
            remediation: "Install the latest Windows security updates from Windows Update.".to_string(),
        },
        Vulnerability {
            id: generate_id(),
            cve_id: Some("CVE-2023-44487".to_string()),
            title: "HTTP/2 Rapid Reset Attack".to_string(),
            description: "The HTTP/2 protocol allows a denial of service through rapid stream reset requests.".to_string(),
            severity: Severity::High,
            affected_software: "Google Chrome".to_string(),
            current_version: "118.0.5993.70".to_string(),
            fixed_version: Some("118.0.5993.117".to_string()),
            detected_at: chrono::Utc::now(),
            status: "open".to_string(),
            remediation: "Update Google Chrome to the latest version.".to_string(),
        },
        Vulnerability {
            id: generate_id(),
            cve_id: None,
            title: "Outdated Adobe Reader".to_string(),
            description: "Adobe Reader is significantly outdated and may contain known security vulnerabilities.".to_string(),
            severity: Severity::Medium,
            affected_software: "Adobe Reader".to_string(),
            current_version: "2023.001.20064".to_string(),
            fixed_version: Some("2024.001.20604".to_string()),
            detected_at: chrono::Utc::now(),
            status: "open".to_string(),
            remediation: "Download and install the latest version of Adobe Reader from Adobe's website.".to_string(),
        },
        Vulnerability {
            id: generate_id(),
            cve_id: None,
            title: "Weak Password Policy".to_string(),
            description: "System password policy does not enforce minimum complexity requirements.".to_string(),
            severity: Severity::Medium,
            affected_software: "Windows Security Policy".to_string(),
            current_version: "N/A".to_string(),
            fixed_version: None,
            detected_at: chrono::Utc::now(),
            status: "open".to_string(),
            remediation: "Configure password policy in Local Security Policy to require minimum length of 12 characters with complexity.".to_string(),
        },
        Vulnerability {
            id: generate_id(),
            cve_id: None,
            title: "Windows Defender Real-time Protection Disabled".to_string(),
            description: "Real-time protection is currently disabled, leaving the system vulnerable to malware.".to_string(),
            severity: Severity::Critical,
            affected_software: "Windows Defender".to_string(),
            current_version: "N/A".to_string(),
            fixed_version: None,
            detected_at: chrono::Utc::now(),
            status: "open".to_string(),
            remediation: "Enable Windows Defender real-time protection in Windows Security settings.".to_string(),
        },
    ])
}

